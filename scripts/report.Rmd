---
title: "Basic exploratory plots"
output:
  html_document:
      keep_md: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center",
                      warning = FALSE,
                      message = FALSE,
                      dev = c("png", "pdf"))
```

## Needed libraries
```{r libraries, message=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(data.table)
```

## Read from Snakemake input

Reading clonotypes from "`r snakemake@input`".

```{r}
# Read clonotype table
clonotypes <- fread(snakemake@input[[1]], sep="\t", header=TRUE)
sprintf("The clonotypes table has %d rows", nrow(clonotypes))

# Read merged processed sample table
aligned_sequences <- fread(snakemake@input[[2]], sep="\t", header=TRUE)
sprintf("The merged aligned tables have %d rows", nrow(aligned_sequences))
```

## Comparing somatic hypermutation

### Normality distribution

Quantile-quantile plots to evaluate theoretical vs observed quantile data. Normally distributed values should follow the theoretical line, while points diverging from the theoretical line means that the sample does not follow a normal distribution.

```{r norm_test}
aligned_sequences %>%
  ggplot(aes(sample = V_SHM, color = id)) +
  stat_qq() + stat_qq_line() +
  facet_grid(~id) +
  theme_classic()
```

### Comparison of somatic hypermutation between groups

Comparison between percentage of somatic hypermutation (SHM) on the IGHV gene between the studied groups and/or timepoints.

```{r shm_between_groups}
aligned_sequences %>%
  ggplot(aes(x = id ,y = V_SHM, color = id)) +
  geom_violin(draw_quantiles = TRUE, trim = TRUE, na.rm = TRUE) +
  theme_classic() +
  theme(legend.position = "none")
```

### Comparison of somatic hypermutation across variable gene

Comparison between percentage of somatic hypermutation (SHM) on different regions of IGHV gene, including both the framework regions (FR1-FR3) and the the complementarity-determining regions (CDR1-2). 

```{r shm_location}
aligned_sequences %>%
  pivot_longer(cols = c("V_SHM", "FR1_SHM", "CDR1_SHM", "FR2_SHM", "CDR2_SHM", "FR3_SHM" ), names_to = "SHM_location", values_to = "SHM_value") %>%
  mutate(SHM_location = factor(SHM_location, levels = c("V_SHM", "FR1_SHM", "CDR1_SHM", "FR2_SHM", "CDR2_SHM", "FR3_SHM"))) %>%
  ggplot(aes(x= SHM_location, y = SHM_value, fill = SHM_location, group = SHM_location)) +
  geom_violin(trim = TRUE) +
  labs(x = "", y = "Somatic hypermutation (Log2 %)") +
  theme_classic() +
  scale_y_continuous(trans = "log2") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```
